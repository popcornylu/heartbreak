<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¿ƒè‡Ÿç—… - é›™äººå°æˆ°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a5f2a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
        }

        /* æ‹ç‰Œå€åŸŸ */
        .slap-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.3);
            transition: background-color 0.1s;
            position: relative;
        }

        .slap-zone.player1 {
            background: #1a1a1a;
            transform: rotate(180deg);
        }

        .slap-zone.player2 {
            background: #1a1a1a;
        }

        .slap-zone.winner {
            background: #27ae60 !important;
        }

        .slap-zone.loser {
            background: #c0392b !important;
        }

        .slap-zone.second-wrong {
            background: #f39c12 !important;
        }

        /* ç´…è‰²æŒ‰éˆ• */
        .slap-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border: 6px solid #922b21;
            box-shadow:
                0 8px 0 #7b241c,
                0 12px 20px rgba(0, 0, 0, 0.5),
                inset 0 -4px 10px rgba(0, 0, 0, 0.3),
                inset 0 4px 10px rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            margin: 1rem auto;
        }

        .slap-button:active {
            transform: translateY(6px);
            box-shadow:
                0 2px 0 #7b241c,
                0 4px 10px rgba(0, 0, 0, 0.5),
                inset 0 -2px 5px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.2);
        }

        /* åé¥‹åœ–ç¤º */
        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
        }

        .feedback.show {
            opacity: 1;
        }

        .feedback.correct {
            color: #2ecc71;
            text-shadow: 0 0 30px rgba(46, 204, 113, 0.8);
        }

        .feedback.wrong {
            color: #e74c3c;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.8);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .card-count {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }

        /* æ£„ç‰Œå †è¦–è¦ºæ•ˆæœ */
        .discard-pile {
            position: relative;
            width: 100px;
            height: 80px;
            margin: 0.5rem auto;
        }

        .discard-card {
            position: absolute;
            width: 50px;
            height: 70px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
        }

        /* ä¸­é–“ç‰Œå€ */
        .center-area {
            width: 300px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #145224;
            position: relative;
        }

        .call-number {
            font-size: 5rem;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .card-area {
            width: 200px;
            height: 280px;
            position: relative;
            perspective: 1000px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: absolute;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .card.back {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .card.back::before {
            content: "ğŸ‚ ";
            font-size: 6rem;
        }

        .card.front {
            background: white;
        }

        .card.red {
            color: #e74c3c;
        }

        .card.black {
            color: #2c3e50;
        }

        .card.joker {
            color: #9b59b6;
            background: linear-gradient(135deg, #fff 0%, #f0e6ff 100%);
        }

        .deck-count {
            margin-top: 2rem;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* é–‹å§‹ç•«é¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
        }

        .start-screen h1 {
            font-size: 4rem;
            margin-bottom: 2rem;
        }

        .start-screen p {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }

        .start-btn {
            margin-top: 2rem;
            padding: 1.5rem 4rem;
            font-size: 2rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .start-btn:active {
            background: #c0392b;
        }

        /* æš«åœæŒ‰éˆ• */
        .pause-btn {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }

        .pause-btn:active {
            background: rgba(255, 255, 255, 0.4);
        }

        /* æš«åœç•«é¢ */
        .pause-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
        }

        .pause-screen.show {
            display: flex;
        }

        .pause-screen h2 {
            font-size: 3rem;
            margin-bottom: 3rem;
        }

        .pause-menu {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pause-menu button {
            padding: 1rem 3rem;
            font-size: 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            min-width: 200px;
        }

        .pause-menu .continue-btn {
            background: #27ae60;
            color: white;
        }

        .pause-menu .restart-btn {
            background: #f39c12;
            color: white;
        }

        .pause-menu .exit-btn {
            background: #e74c3c;
            color: white;
        }

        /* çµæœç•«é¢ */
        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
        }

        .result-screen.show {
            display: flex;
        }

        .result-screen h2 {
            font-size: 3rem;
            margin-bottom: 2rem;
        }

        .hidden {
            display: none !important;
        }

        /* ç‰ˆæœ¬è™Ÿ */
        .version {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.4);
            z-index: 1000;
        }

        /* è¨Šæ¯æç¤º */
        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #f1c40f;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */

        /* iPhone ç›´å‘ (å¯¬åº¦ < 600px) */
        @media screen and (max-width: 600px) {
            .game-container {
                flex-direction: column;
            }

            .slap-zone.player1 {
                transform: rotate(180deg);
            }

            .center-area {
                width: 100%;
                min-width: auto;
                height: 200px;
                min-height: 200px;
                flex-direction: row;
                padding: 10px;
            }

            .call-number {
                font-size: 3rem;
                margin-bottom: 0;
                margin-right: 1rem;
            }

            .card-area {
                width: 100px;
                height: 140px;
            }

            .card {
                font-size: 2rem;
                border-radius: 10px;
            }

            .deck-count {
                margin-top: 0;
                margin-left: 1rem;
                font-size: 1rem;
            }

            .player-name {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }

            .slap-button {
                width: 80px;
                height: 80px;
                margin: 0.5rem auto;
            }

            .discard-pile {
                width: 60px;
                height: 50px;
            }

            .discard-card {
                width: 30px;
                height: 42px;
                font-size: 0.5rem;
            }

            .card-count {
                font-size: 1rem;
            }

            .feedback {
                font-size: 5rem;
            }

            .pause-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: auto;
                bottom: 10px;
                left: 10px;
                transform: none;
            }

            .message {
                font-size: 1.2rem;
            }

            .start-screen h1 {
                font-size: 2.5rem;
            }

            .start-screen p {
                font-size: 1rem;
            }

            .start-btn {
                padding: 1rem 2rem;
                font-size: 1.5rem;
            }

            .pause-screen h2 {
                font-size: 2rem;
            }

            .pause-menu button {
                padding: 0.8rem 2rem;
                font-size: 1.2rem;
                min-width: 150px;
            }

            .result-screen h2 {
                font-size: 2rem;
            }
        }

        /* iPhone æ©«å‘ & å°å¹³æ¿ (600px - 900px) */
        @media screen and (min-width: 601px) and (max-width: 900px) {
            .center-area {
                width: 200px;
                min-width: 200px;
            }

            .call-number {
                font-size: 3.5rem;
            }

            .card-area {
                width: 140px;
                height: 196px;
            }

            .slap-button {
                width: 100px;
                height: 100px;
            }

            .feedback {
                font-size: 6rem;
            }
        }
    </style>
</head>
<body>
    <div class="version">v0.6.0</div>

    <!-- é–‹å§‹ç•«é¢ -->
    <div class="start-screen" id="startScreen">
        <h1>â¤ï¸ å¿ƒè‡Ÿç—…</h1>
        <p>éŠæˆ²è¦å‰‡ï¼š</p>
        <p>1. ç³»çµ±è‡ªå‹•å–Šæ•¸ 1â†’2â†’3â†’...â†’13â†’1</p>
        <p>2. ç•¶ç¿»å‡ºçš„ç‰Œ = å–Šçš„æ•¸å­—æ™‚ï¼Œå¿«æ‹ï¼</p>
        <p>3. ğŸƒ Joker å‡ºç¾æ™‚ï¼Œä¸ç®¡å–Šä»€éº¼éƒ½è¦æ‹ï¼</p>
        <p>4. æ‹æ…¢æˆ–æ‹éŒ¯çš„äººæ”¶èµ°ç‰Œå †</p>
        <p>5. 54å¼µç‰Œç™¼å®Œæ™‚ï¼Œæ£„ç‰Œæœ€å°‘è€…ç²å‹ï¼</p>
        <br>
        <p>ğŸ“± å…©ä½ç©å®¶å„ç«™ iPad ä¸€å´</p>
        <button class="start-btn" id="startBtn">é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div class="game-container" id="gameContainer">
        <!-- ç©å®¶1 æ‹ç‰Œå€ (å·¦å´/ä¸Šæ–¹æ—‹è½‰180åº¦) -->
        <div class="slap-zone player1" id="player1Zone">
            <div class="feedback" id="player1Feedback"></div>
            <div class="player-info">
                <div class="player-name">ç©å®¶ 1</div>
                <div class="slap-button" id="player1Button"></div>
                <div class="discard-pile" id="player1Discard"></div>
                <div class="card-count">æ£„ç‰Œ: <span id="player1Cards">0</span> å¼µ</div>
            </div>
        </div>

        <!-- ä¸­é–“ç‰Œå€ -->
        <div class="center-area">
            <button class="pause-btn" id="pauseBtn">â¸</button>
            <div class="call-number" id="callNumber">-</div>
            <div class="card-area" id="cardArea"></div>
            <div class="deck-count">ç‰Œå †: <span id="deckCount">0</span></div>
            <div class="message" id="message"></div>
        </div>

        <!-- ç©å®¶2 æ‹ç‰Œå€ (å³å´) -->
        <div class="slap-zone player2" id="player2Zone">
            <div class="feedback" id="player2Feedback"></div>
            <div class="player-info">
                <div class="player-name">ç©å®¶ 2</div>
                <div class="slap-button" id="player2Button"></div>
                <div class="discard-pile" id="player2Discard"></div>
                <div class="card-count">æ£„ç‰Œ: <span id="player2Cards">0</span> å¼µ</div>
            </div>
        </div>
    </div>

    <!-- æš«åœç•«é¢ -->
    <div class="pause-screen" id="pauseScreen">
        <h2>â¸ éŠæˆ²æš«åœ</h2>
        <div class="pause-menu">
            <button class="continue-btn" id="continueBtn">ç¹¼çºŒéŠæˆ²</button>
            <button class="restart-btn" id="pauseRestartBtn">é‡æ–°é–‹å§‹</button>
            <button class="exit-btn" id="exitBtn">é›¢é–‹éŠæˆ²</button>
        </div>
    </div>

    <!-- çµæœç•«é¢ -->
    <div class="result-screen" id="resultScreen">
        <h2 id="resultText"></h2>
        <button class="start-btn" id="restartBtn">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹
        const state = {
            deck: [],              // ç³»çµ±ç‰Œå †
            player1Discard: [],    // ç©å®¶1æ£„ç‰Œå †
            player2Discard: [],    // ç©å®¶2æ£„ç‰Œå †
            centerPile: [],        // ä¸­å¤®ç‰Œå †
            currentNumber: 0,      // ç•¶å‰å–Šçš„æ•¸å­— (1-13)
            currentCard: null,
            isPlaying: false,
            isPaused: false,
            canSlap: false,
            flipTimeout: null,
            slapRecorded: { player1: null, player2: null }
        };

        // DOM å…ƒç´ 
        const elements = {
            startScreen: document.getElementById('startScreen'),
            startBtn: document.getElementById('startBtn'),
            player1Zone: document.getElementById('player1Zone'),
            player2Zone: document.getElementById('player2Zone'),
            player1Cards: document.getElementById('player1Cards'),
            player2Cards: document.getElementById('player2Cards'),
            player1Discard: document.getElementById('player1Discard'),
            player2Discard: document.getElementById('player2Discard'),
            player1Button: document.getElementById('player1Button'),
            player2Button: document.getElementById('player2Button'),
            player1Feedback: document.getElementById('player1Feedback'),
            player2Feedback: document.getElementById('player2Feedback'),
            callNumber: document.getElementById('callNumber'),
            cardArea: document.getElementById('cardArea'),
            deckCount: document.getElementById('deckCount'),
            message: document.getElementById('message'),
            resultScreen: document.getElementById('resultScreen'),
            resultText: document.getElementById('resultText'),
            restartBtn: document.getElementById('restartBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            pauseScreen: document.getElementById('pauseScreen'),
            continueBtn: document.getElementById('continueBtn'),
            pauseRestartBtn: document.getElementById('pauseRestartBtn'),
            exitBtn: document.getElementById('exitBtn')
        };

        // éŸ³æ•ˆç³»çµ±
        let audioCtx = null;
        function getAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        }

        // ç™¼ç‰ŒéŸ³æ•ˆ - çŸ­ä¿ƒçš„å’»è²
        function playCardSound() {
            const ctx = getAudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.1);
        }

        // éŒ¯èª¤éŸ³æ•ˆ - æ‰“æ‰“çš„buzzerè²
        function playErrorSound() {
            const ctx = getAudioContext();
            for (let i = 0; i < 3; i++) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, ctx.currentTime + i * 0.12);
                gain.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.12);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.12 + 0.1);
                osc.start(ctx.currentTime + i * 0.12);
                osc.stop(ctx.currentTime + i * 0.12 + 0.1);
            }
        }

        // æˆåŠŸéŸ³æ•ˆ - å®å’šå®å’š
        function playSuccessSound() {
            const ctx = getAudioContext();
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.15);
                gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.2);
                osc.start(ctx.currentTime + i * 0.15);
                osc.stop(ctx.currentTime + i * 0.15 + 0.2);
            });
        }

        // æ’²å…‹ç‰ŒèŠ±è‰²
        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const suitColors = { 'â™ ': 'black', 'â™¥': 'red', 'â™¦': 'red', 'â™£': 'black' };

        // å»ºç«‹ä¸€å‰¯ç‰Œ (52å¼µ + 2å¼µJoker = 54å¼µ)
        function createDeck() {
            const deck = [];
            for (let suit of suits) {
                for (let num = 1; num <= 13; num++) {
                    deck.push({ suit, num, isJoker: false });
                }
            }
            // åŠ å…¥2å¼µJoker
            deck.push({ isJoker: true });
            deck.push({ isJoker: true });
            return shuffle(deck);
        }

        // æ´—ç‰Œ
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // æ•¸å­—é¡¯ç¤º
        function getCardDisplay(num) {
            const displays = ['', 'A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            return displays[num];
        }

        // é¡¯ç¤ºå¡ç‰Œ - ç–ŠåŠ åˆ°ç‰Œå †ä¸Š
        function displayCard(card) {
            const cardEl = document.createElement('div');

            if (card.isJoker) {
                cardEl.className = 'card front joker';
                cardEl.innerHTML = 'ğŸƒ<br>JOKER';
            } else {
                const display = getCardDisplay(card.num);
                const color = suitColors[card.suit];
                cardEl.className = `card front ${color}`;
                cardEl.innerHTML = `${card.suit}<br>${display}`;
            }

            // éš¨æ©Ÿåç§»å’Œæ—‹è½‰
            const rotation = (Math.random() - 0.5) * 30; // -15 åˆ° 15 åº¦
            const offsetX = (Math.random() - 0.5) * 20;  // -10 åˆ° 10 px
            const offsetY = (Math.random() - 0.5) * 20;  // -10 åˆ° 10 px
            const pileIndex = elements.cardArea.children.length;

            cardEl.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${rotation}deg)`;
            cardEl.style.zIndex = pileIndex;

            elements.cardArea.appendChild(cardEl);
        }

        // æ¸…ç©ºç‰Œå †è¦–è¦º
        function clearPileVisual() {
            elements.cardArea.innerHTML = '';
        }

        // é¡¯ç¤ºç‰ŒèƒŒï¼ˆåˆå§‹ç‹€æ…‹ï¼‰
        function displayCardBack() {
            clearPileVisual();
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, duration = 1500) {
            elements.message.textContent = text;
            setTimeout(() => {
                elements.message.textContent = '';
            }, duration);
        }

        // é¡¯ç¤ºåé¥‹ (åœˆåœˆæˆ–å‰å‰)
        function showFeedback(player, isCorrect) {
            const feedbackEl = player === 1 ? elements.player1Feedback : elements.player2Feedback;
            feedbackEl.textContent = isCorrect ? 'â­•' : 'âŒ';
            feedbackEl.className = `feedback show ${isCorrect ? 'correct' : 'wrong'}`;
        }

        // æ¸…é™¤æ‰€æœ‰åé¥‹å’ŒèƒŒæ™¯
        function clearAllFeedback() {
            elements.player1Feedback.className = 'feedback';
            elements.player2Feedback.className = 'feedback';
            elements.player1Zone.classList.remove('winner', 'loser', 'second-wrong');
            elements.player2Zone.classList.remove('winner', 'loser', 'second-wrong');
        }

        // æ–°å¢ç‰Œåˆ°æ£„ç‰Œå †è¦–è¦ºï¼ˆåªåŠ å…¥æ–°çš„ç‰Œï¼‰
        function updateDiscardVisual(discardElement, cards) {
            const currentCount = discardElement.children.length;
            const maxVisible = 12; // æœ€å¤šé¡¯ç¤ºå¹¾å¼µ

            // åªåŠ å…¥æ–°çš„ç‰Œ
            for (let i = currentCount; i < cards.length && i < maxVisible; i++) {
                const card = document.createElement('div');
                card.className = 'discard-card';
                // éš¨æ©Ÿä½ç½®å’Œè§’åº¦è£½é€ äº‚äº‚çš„æ„Ÿè¦º
                const rotation = (Math.random() - 0.5) * 40; // -20 åˆ° 20 åº¦
                const offsetX = (Math.random() - 0.5) * 50;  // -25 åˆ° 25 px
                const offsetY = (Math.random() - 0.5) * 20;  // -10 åˆ° 10 px
                card.style.left = `${25 + offsetX}px`;
                card.style.top = `${5 + offsetY}px`;
                card.style.transform = `rotate(${rotation}deg)`;
                card.style.zIndex = i;
                card.textContent = 'ğŸ‚ ';
                discardElement.appendChild(card);
            }
        }

        // æ›´æ–°ç•«é¢
        function updateUI() {
            elements.player1Cards.textContent = state.player1Discard.length;
            elements.player2Cards.textContent = state.player2Discard.length;
            elements.deckCount.textContent = state.deck.length;
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            elements.startScreen.classList.add('hidden');

            // å»ºç«‹ä¸¦æ´—ç‰Œ
            state.deck = createDeck();
            state.player1Discard = [];
            state.player2Discard = [];
            state.centerPile = [];
            state.currentNumber = 0;
            state.isPlaying = true;
            state.canSlap = false;

            // æ¸…ç©ºæ£„ç‰Œå †è¦–è¦º
            elements.player1Discard.innerHTML = '';
            elements.player2Discard.innerHTML = '';

            updateUI();
            displayCardBack();
            elements.callNumber.textContent = '-';

            // å»¶é²é–‹å§‹ç¿»ç‰Œ
            setTimeout(flipCard, 1500);
        }

        // ç¿»ç‰Œ
        function flipCard() {
            if (!state.isPlaying) return;

            // æª¢æŸ¥ç‰Œå †æ˜¯å¦é‚„æœ‰ç‰Œ
            if (state.deck.length === 0) {
                endGame();
                return;
            }

            // é‡ç½®æ‹ç‰Œç´€éŒ„å’Œåé¥‹
            state.slapRecorded = { player1: null, player2: null };
            state.canSlap = false;
            clearAllFeedback();

            // æ›´æ–°å–Šçš„æ•¸å­—
            state.currentNumber = (state.currentNumber % 13) + 1;
            elements.callNumber.textContent = getCardDisplay(state.currentNumber);

            // å¾ç‰Œå †æŠ½ä¸€å¼µç‰Œ
            const card = state.deck.pop();
            state.currentCard = card;
            state.centerPile.push(card);

            // é¡¯ç¤ºç¿»ç‰Œå‹•ç•«
            displayCard(card);
            playCardSound();
            updateUI();

            // å…è¨±æ‹ç‰Œ
            state.canSlap = true;

            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ‹ (ç‰Œ = å–Šçš„æ•¸å­— æˆ– Joker)
            const shouldSlap = card.isJoker || card.num === state.currentNumber;

            if (shouldSlap) {
                // ç­‰å¾…æ‹ç‰Œ (æœ€å¤š2ç§’)
                state.flipTimeout = setTimeout(() => {
                    // æ™‚é–“åˆ°é‚„æ²’äººæ‹ï¼Œè¦–ç‚ºå¹³æ‰‹ï¼Œç¹¼çºŒ
                    if (state.canSlap && !state.isPaused) {
                        showMessage('éƒ½æ²’æ‹ï¼ç¹¼çºŒ...');
                        state.canSlap = false;
                        state.flipTimeout = setTimeout(() => {
                            if (state.isPlaying && !state.isPaused) flipCard();
                        }, 1000);
                    }
                }, 2000);
            } else {
                // ä¸éœ€è¦æ‹ï¼Œæº–å‚™ä¸‹ä¸€å¼µ
                state.flipTimeout = setTimeout(() => {
                    if (state.isPlaying && !state.isPaused) {
                        flipCard();
                    }
                }, 1200);
            }
        }

        // è™•ç†æ‹ç‰Œ
        function handleSlap(player) {
            if (!state.isPlaying || !state.canSlap || state.isPaused) return;

            const now = performance.now();
            const shouldSlap = state.currentCard && (state.currentCard.isJoker || state.currentCard.num === state.currentNumber);

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æŒ‰é
            if (player === 1 && state.slapRecorded.player1 !== null) return;
            if (player === 2 && state.slapRecorded.player2 !== null) return;

            // è¨˜éŒ„æ‹ç‰Œæ™‚é–“å’Œæ˜¯å¦æ­£ç¢º
            if (player === 1) {
                state.slapRecorded.player1 = { time: now, correct: shouldSlap };
            } else {
                state.slapRecorded.player2 = { time: now, correct: shouldSlap };
            }

            // ç«‹å³é¡¯ç¤ºåé¥‹
            showFeedback(player, shouldSlap);

            // æª¢æŸ¥æ˜¯å¦å…©äººéƒ½æ‹äº†
            if (state.slapRecorded.player1 !== null && state.slapRecorded.player2 !== null) {
                clearTimeout(state.flipTimeout);
                state.canSlap = false;
                judgeSlap();
            } else {
                // åªæœ‰ä¸€äººæ‹ï¼Œç­‰å¦ä¸€äºº
                clearTimeout(state.flipTimeout);
                state.flipTimeout = setTimeout(() => {
                    if (state.canSlap) {
                        state.canSlap = false;
                        judgeSlap();
                    }
                }, 500);
            }
        }

        // åˆ¤æ–·æ‹ç‰Œçµæœ
        function judgeSlap() {
            const p1 = state.slapRecorded.player1;
            const p2 = state.slapRecorded.player2;
            const pileCount = state.centerPile.length;

            let loser = null;

            // æƒ…æ³åˆ†æ
            if (p1 === null && p2 === null) {
                // éƒ½æ²’æ‹
                state.flipTimeout = setTimeout(() => {
                    if (state.isPlaying && !state.isPaused) flipCard();
                }, 1000);
                return;
            }

            if (p1 !== null && p2 === null) {
                // åªæœ‰ç©å®¶1æ‹äº†
                if (p1.correct) {
                    // ç©å®¶1æ­£ç¢ºï¼Œç©å®¶2æ²’æ‹ = ç©å®¶2è¼¸
                    elements.player1Zone.classList.add('winner');
                    loser = 2;
                } else {
                    // ç©å®¶1æ‹éŒ¯
                    elements.player1Zone.classList.add('loser');
                    loser = 1;
                }
            } else if (p2 !== null && p1 === null) {
                // åªæœ‰ç©å®¶2æ‹äº†
                if (p2.correct) {
                    elements.player2Zone.classList.add('winner');
                    loser = 1;
                } else {
                    elements.player2Zone.classList.add('loser');
                    loser = 2;
                }
            } else {
                // å…©äººéƒ½æ‹äº†
                const p1First = p1.time < p2.time;

                if (p1.correct && p2.correct) {
                    // éƒ½å°ï¼Œå…ˆæŒ‰çš„è´
                    if (p1First) {
                        elements.player1Zone.classList.add('winner');
                        elements.player2Zone.classList.add('loser');
                        loser = 2;
                    } else {
                        elements.player2Zone.classList.add('winner');
                        elements.player1Zone.classList.add('loser');
                        loser = 1;
                    }
                    playSuccessSound();
                    setTimeout(playErrorSound, 300);
                } else if (!p1.correct && !p2.correct) {
                    // éƒ½éŒ¯ï¼Œå…ˆæŒ‰çš„ç´…è‰²ï¼Œå¾ŒæŒ‰çš„é»ƒè‰²
                    if (p1First) {
                        elements.player1Zone.classList.add('loser');
                        elements.player2Zone.classList.add('second-wrong');
                        loser = 1;
                    } else {
                        elements.player2Zone.classList.add('loser');
                        elements.player1Zone.classList.add('second-wrong');
                        loser = 2;
                    }
                    playErrorSound();
                } else if (p1.correct && !p2.correct) {
                    // ç©å®¶1å°ï¼Œç©å®¶2éŒ¯
                    elements.player1Zone.classList.add('winner');
                    elements.player2Zone.classList.add('loser');
                    loser = 2;
                    playSuccessSound();
                } else {
                    // ç©å®¶2å°ï¼Œç©å®¶1éŒ¯
                    elements.player2Zone.classList.add('winner');
                    elements.player1Zone.classList.add('loser');
                    loser = 1;
                    playSuccessSound();
                }
            }

            // è¼¸å®¶æ”¶ç‰Œåˆ°æ£„ç‰Œå †
            if (loser === 1) {
                state.player1Discard.push(...state.centerPile);
                showMessage(`ç©å®¶1æ”¶ ${pileCount} å¼µç‰Œ`);
                updateDiscardVisual(elements.player1Discard, state.player1Discard);
            } else if (loser === 2) {
                state.player2Discard.push(...state.centerPile);
                showMessage(`ç©å®¶2æ”¶ ${pileCount} å¼µç‰Œ`);
                updateDiscardVisual(elements.player2Discard, state.player2Discard);
            }

            state.centerPile = [];
            state.currentNumber = 0; // é‡æ–°å¾1é–‹å§‹æ•¸
            updateUI();

            // æª¢æŸ¥ç‰Œå †æ˜¯å¦é‚„æœ‰ç‰Œ
            if (state.deck.length === 0) {
                state.flipTimeout = setTimeout(() => {
                    if (!state.isPaused) endGame();
                }, 1500);
            } else {
                state.flipTimeout = setTimeout(() => {
                    if (state.isPaused) return;
                    clearAllFeedback();
                    displayCardBack();
                    state.flipTimeout = setTimeout(() => {
                        if (state.isPlaying && !state.isPaused) flipCard();
                    }, 1000);
                }, 1500);
            }
        }

        // çµæŸéŠæˆ²
        function endGame() {
            state.isPlaying = false;
            clearTimeout(state.flipTimeout);

            const p1Count = state.player1Discard.length;
            const p2Count = state.player2Discard.length;

            let winner;
            let resultText;

            if (p1Count < p2Count) {
                winner = 'ç©å®¶ 1';
                resultText = `ğŸ‰ ${winner} ç²å‹ï¼\n(${p1Count} vs ${p2Count} å¼µæ£„ç‰Œ)`;
            } else if (p2Count < p1Count) {
                winner = 'ç©å®¶ 2';
                resultText = `ğŸ‰ ${winner} ç²å‹ï¼\n(${p2Count} vs ${p1Count} å¼µæ£„ç‰Œ)`;
            } else {
                resultText = `ğŸ¤ å¹³æ‰‹ï¼\n(é›™æ–¹éƒ½æ˜¯ ${p1Count} å¼µæ£„ç‰Œ)`;
            }

            elements.resultText.innerHTML = resultText.replace('\n', '<br>');
            elements.resultScreen.classList.add('show');
        }

        // æš«åœéŠæˆ²
        function pauseGame() {
            if (!state.isPlaying || state.isPaused) return;
            state.isPaused = true;
            clearTimeout(state.flipTimeout);
            elements.pauseScreen.classList.add('show');
        }

        // ç¹¼çºŒéŠæˆ²
        function resumeGame() {
            if (!state.isPaused) return;
            state.isPaused = false;
            elements.pauseScreen.classList.remove('show');
            // å¦‚æœä¸åœ¨ç­‰å¾…æ‹ç‰Œç‹€æ…‹ï¼Œç¹¼çºŒç¿»ç‰Œ
            if (!state.canSlap) {
                setTimeout(flipCard, 500);
            }
        }

        // é›¢é–‹éŠæˆ²ï¼ˆå›åˆ°é–‹å§‹ç•«é¢ï¼‰
        function exitGame() {
            state.isPlaying = false;
            state.isPaused = false;
            clearTimeout(state.flipTimeout);
            elements.pauseScreen.classList.remove('show');
            elements.startScreen.classList.remove('hidden');
        }

        // è§¸æ§äº‹ä»¶è™•ç†
        function setupTouchEvents() {
            // é˜²æ­¢é è¨­è¡Œç‚º
            document.addEventListener('touchstart', (e) => {
                e.preventDefault();
            }, { passive: false });

            // ç©å®¶1 æŒ‰éˆ•è§¸æ§
            elements.player1Button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleSlap(1);
            }, { passive: false });

            // ç©å®¶2 æŒ‰éˆ•è§¸æ§
            elements.player2Button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleSlap(2);
            }, { passive: false });

            // æ»‘é¼ äº‹ä»¶ (ç”¨æ–¼æ¸¬è©¦)
            elements.player1Button.addEventListener('mousedown', () => handleSlap(1));
            elements.player2Button.addEventListener('mousedown', () => handleSlap(2));
        }

        // æŒ‰éˆ•äº‹ä»¶ (åŒæ™‚æ”¯æ´ click å’Œ touch)
        elements.startBtn.addEventListener('click', startGame);
        elements.startBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            startGame();
        });
        elements.restartBtn.addEventListener('click', () => {
            elements.resultScreen.classList.remove('show');
            startGame();
        });
        elements.restartBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            elements.resultScreen.classList.remove('show');
            startGame();
        });

        // æš«åœæŒ‰éˆ•äº‹ä»¶
        elements.pauseBtn.addEventListener('click', pauseGame);
        elements.pauseBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            pauseGame();
        });

        // ç¹¼çºŒæŒ‰éˆ•
        elements.continueBtn.addEventListener('click', resumeGame);
        elements.continueBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            resumeGame();
        });

        // æš«åœç•«é¢é‡æ–°é–‹å§‹æŒ‰éˆ•
        elements.pauseRestartBtn.addEventListener('click', () => {
            elements.pauseScreen.classList.remove('show');
            state.isPaused = false;
            startGame();
        });
        elements.pauseRestartBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            elements.pauseScreen.classList.remove('show');
            state.isPaused = false;
            startGame();
        });

        // é›¢é–‹æŒ‰éˆ•
        elements.exitBtn.addEventListener('click', exitGame);
        elements.exitBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            exitGame();
        });

        // åˆå§‹åŒ–
        setupTouchEvents();

        // é˜²æ­¢ç¸®æ”¾
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        document.addEventListener('gesturechange', (e) => e.preventDefault());
    </script>
</body>
</html>
